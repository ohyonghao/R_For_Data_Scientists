---
title: "Homework 3"
author: "DTR"
date: 'Due: Tuesday 5/12/2020 by 4:30 pm'
output: rmdformats::material
subtitle: 'STAT 399'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(dplyr)
library(readr)
library(tidyr)
library(pander)
```


# Part 0: Getting to know the data

We are grabbing three sets of data to analyze the current Coronavirus situation in the US. We have a time series data, daily reports, and some 
general statistics about each state.

```{r load_data, echo=FALSE, message=FALSE}
covid.usa.ts <- read_csv('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv')

covid.usa.daily <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports_us/05-07-2020.csv") 

popdata <- read_csv("https://www2.census.gov/programs-surveys/popest/tables/2010-2018/state/asrh/sc-est2018-alldata5.csv")
```


```{r}
names(covid.usa.ts)
```

This quick look tells us that the first 11 columns are information, and the last 123 columns are
the time series data.

```{r}
head(covid.usa.daily)
```

We see this information is an aggregate of information between April 14th and May 7th as offered
in the description.


# Part 1: Wrangling the COVID-19 data

Now that we've gotten to see the data a little bit we can now try to wrangle it into a form that we can make some sense out of.
```{r}
library(parallel)
```

To get the primary keys we'll write a quick function to test. If all values are unique then it is
a key.

```{r Primary Keys}
primary_keys <- function( data, keysonly = FALSE ){
        if( keysonly ){
                keys <-primary_keys(data)
                return(keys[keys==TRUE])
        }else{
        mclapply(data, function(x){
                return( length(unique(x)) == length(x))
                })
        }
}
```


Covid USA Time Series"
```{r}
str(primary_keys(covid.usa.ts[,c(1:11)], keysonly=TRUE))
```

The keys for `covid.usa.ts` are the `UID`, and `Combined_Key`. These two each functionaly
determine the rest of the elements.

Covid USA Daily
```{r}
str(primary_keys(covid.usa.daily, keysonly=TRUE))
```

For the `covid.usa.daily` dataset we find `Province_State`, `Confirmed`, `FIPS`, `Mortality_Rate`,
and `UID` are keys.


```{r}
tmp <- left_join( covid.usa.ts[,1:11], rename( covid.usa.daily, ), by= c( "UID" = "UID" ) )
tmp %>% filter(Province_State.x == Province_State.y) %>%
        select( Province_State.x, Province_State.y )
```

The foreign keys between these two tables is the `Province_State` which is in `covid.usa.ts` 
with the foreign key being in `covid.usa.daily`. The `UID` column does not appear to be a
foreign key.

## Aggregating State Level Data

```{r State Level Time Series}
covid.usa.states.ts <- covid.usa.ts %>%
        group_by(Province_State) %>%
        summarize_at( vars(-names(.)[1:6],-names(.)[8:11]) ,sum,na.rm=TRUE )
covid.usa.states.ts
```

## Combining Data

We'll use the foreign key `Province_State` to do a left join on these
tables.

```{r}
covid.usa.all <- left_join(covid.usa.daily, covid.usa.states.ts,  by="Province_State")
```



# Part 2: Wrangling the population data

We'd like to bucket the age groups

```{r}
names(popdata)
unique(popdata$AGE)
```

Trust, but verify, take a random sample and see that the function worked as
expected.
```{r}
pop.data <- popdata %>%
        mutate(AGE.GRP = case_when(
                (AGE >= 0  & AGE < 6)  ~ "0-5", 
                (AGE >= 6  & AGE < 19) ~ "6-18",
                (AGE >= 19 & AGE < 41) ~ "19-40", 
                (AGE >= 41 & AGE < 71) ~ "41-70",
                (AGE >= 71)            ~ "71+" 
                ) 
              )

sample_n(pop.data, 50) %>%
        select(AGE,AGE.GRP)
```

Now to aggregate the population for 2018.

```{r}
pop.agg <- pop.data %>%
        group_by(NAME, AGE.GRP, SEX) %>%
        select(SUMLEV:AGE,POPESTIMATE2018, AGE.GRP) %>%
        summarize_at( vars(POPESTIMATE2018), sum, na.rm=TRUE) %>%
        ungroup()
head(pop.agg, 5)
```

# Part 3: Let's combine and use the data
